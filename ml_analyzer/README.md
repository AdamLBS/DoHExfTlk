# Network Flow ML Trainer & Predictor

This repository contains **two Python CLI tools** for training and running ML-based detection on network flow CSV files (e.g., DNS-over-HTTPS exfiltration).  
Both scripts share the same feature list and directory structure.

---

## 1) Files

- **`trainer.py`** trains multiple classifiers using a Scikit-Learn **Pipeline + Calibration (isotonic) + threshold tuning**; saves the best model and metadata.
- **`predict.py`**  loads trained pipelines and an optional rule-based **DoHXP** model, runs predictions on a CSV, and outputs a summary.

---

## 2) Directory Structure

```
.
├── datasets/          # Training CSVs with a 'Label' column
├── models/            # Generated by trainer: models, thresholds, metadata
└── ml_reports/        # (Optional) for reports/artifacts
```

Trainer outputs:

- `models/<model_name>.pkl` trained pipeline (preprocessing + classifier)
- `models/best_model.pkl` best model (by test AUC)
- `models/preprocessors.pkl` scaler + label encoder + feature names
- `models/thresholds.json` tuned thresholds per model
- `models/metadata.json` training details

Predictor reads:

- Models in `models/*.pkl` (except `best_model.pkl` and `preprocessors.pkl`)
- `thresholds.json` (optional; otherwise uses `--default-threshold`)
- `dohxp_model.json` (optional; for the rule-based model)

---

## 3) Dataset Format

### For training
- Must have a **`Label`** column (string labels, will be label-encoded).
- Numeric feature columns (missing ones are filled with median values):

```
SourcePort, DestinationPort, Duration,
FlowBytesSent, FlowSentRate, FlowBytesReceived, FlowReceivedRate,
PacketLengthVariance, PacketLengthStandardDeviation, PacketLengthMean,
PacketLengthMedian, PacketLengthMode, PacketLengthSkewFromMedian,
PacketLengthSkewFromMode, PacketLengthCoefficientofVariation,
PacketTimeVariance, PacketTimeStandardDeviation, PacketTimeMean,
PacketTimeMedian, PacketTimeMode, PacketTimeSkewFromMedian,
PacketTimeSkewFromMode, PacketTimeCoefficientofVariation,
ResponseTimeTimeVariance, ResponseTimeTimeStandardDeviation,
ResponseTimeTimeMean, ResponseTimeTimeMedian, ResponseTimeTimeMode,
ResponseTimeTimeSkewFromMedian, ResponseTimeTimeSkewFromMode,
ResponseTimeTimeCoefficientofVariation
```

### For prediction
- **No `Label`** column.
- Missing features will be created and filled with median values.

---

## 4) Installation

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -U pip
pip install -r requirements.txt
```

---

## 5) Training (`trainer.py`)

Run in quick mode for faster iterations:

```bash
python trainer.py --quick --fpr 0.01
```

Options:
- `--quick` — use fewer samples and parameters for faster training.
- `--fpr` — target False Positive Rate for threshold tuning.

---

## 6) Prediction (`predict.py`)

```bash
python predict.py /path/to/file.csv --default-threshold 0.5
```

Options:
- `--default-threshold` — threshold used if not found in `thresholds.json`.
- `--dohxp-config` — path to the DoHXP rule-based model config JSON.

---

## 7) DoHXP Rule-Based Model Example

```json
{
  "rules": [
    { "feature": "PacketLengthMean", "op": ">", "value": 400, "weight": 0.6 },
    { "feature": "PacketTimeVariance", "op": "<", "value": 0.001, "weight": 0.5 },
    { "feature": "FlowReceivedRate", "op": ">", "value": 20000, "weight": 0.4 }
  ],
  "aggregation": "sum",
  "clip": [0.0, 1.0],
  "bias": 0.0
}
```

---

## 8) Workflow Example

```bash
# Train models
python trainer.py --quick --fpr 0.01

# Predict using trained models
python predict.py ../some_flows.csv
```